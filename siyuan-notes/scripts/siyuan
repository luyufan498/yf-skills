#!/usr/bin/env python3
"""
æ€æºç¬”è®°å‘½ä»¤è¡Œå·¥å…· - ä¸»å…¥å£
"""

import sys
import argparse
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from core.router import CommandRouter
from core.exceptions import SiyuanError
from core.config import Config


def create_parser():
    """åˆ›å»ºå‘½ä»¤è¡Œå‚æ•°è§£æå™¨"""
    parser = argparse.ArgumentParser(
        prog="siyuan",
        description="æ€æºç¬”è®°å‘½ä»¤è¡Œå·¥å…·",
        epilog="""
ç¤ºä¾‹:
  siyuan nb list                      åˆ—å‡ºæ‰€æœ‰ç¬”è®°æœ¬
  siyuan nb list --tree               ä»¥æ ‘çŠ¶ç»“æ„æ˜¾ç¤º
  siyuan doc show <doc-id>            æŸ¥çœ‹æ–‡æ¡£å†…å®¹
  siyuan doc list <notebook>          åˆ—å‡ºç¬”è®°æœ¬çš„æ–‡æ¡£
  siyuan blk update <id> "æ–°å†…å®¹"     æ›´æ–°å—å†…å®¹
  siyuan query search "å…³é”®è¯"        æœç´¢åŒ…å«å…³é”®è¯çš„å—
  siyuan export md <doc-id>           å¯¼å‡ºæ–‡æ¡£ä¸º Markdown

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ: https://github.com/siyuan-note/siyuan
        """
    )

    parser.add_argument(
        '--version',
        action='version',
        version='%(prog)s 1.0.0'
    )

    # å­å‘½ä»¤
    subparsers = parser.add_subparsers(
        dest='module',
        help='æ¨¡å—åç§°',
        metavar='<module>'
    )

    # ç¬”è®°æœ¬æ¨¡å—
    nb_parser = subparsers.add_parser(
        'nb',
        help='ç¬”è®°æœ¬æ“ä½œ (notebook çš„ç®€å†™)',
        aliases=['notebook']
    )
    nb_subparsers = nb_parser.add_subparsers(dest='action', help='åŠ¨ä½œ')

    # nb list
    list_nb = nb_subparsers.add_parser('list',
        help='åˆ—å‡ºæ‰€æœ‰ç¬”è®°æœ¬',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  siyuan nb list                      åˆ—å‡ºæ‰€æœ‰ç¬”è®°æœ¬ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
  siyuan nb list --tree               ä»¥æ ‘çŠ¶ç»“æ„æ˜¾ç¤º
  siyuan nb list --show-docs          æ˜¾ç¤ºæ¯ä¸ªç¬”è®°æœ¬åŠå…¶æ–‡æ¡£åˆ—è¡¨
  siyuan nb list --show-docs --tree   ä»¥æ ‘çŠ¶ç»“æ„æ˜¾ç¤ºæ‰€æœ‰æ–‡æ¡£
  siyuan nb list --format json       ä»¥ JSON æ ¼å¼è¾“å‡º
        """
    )
    list_nb.add_argument('--tree', action='store_true', help='ä»¥æ ‘çŠ¶ç»“æ„æ˜¾ç¤º')
    list_nb.add_argument('--format', choices=['text', 'json'], default='text', help='è¾“å‡ºæ ¼å¼')
    list_nb.add_argument('--show-docs', action='store_true', help='æ˜¾ç¤ºæ–‡æ¡£æ•°é‡')

    # nb create
    create_nb = nb_subparsers.add_parser('create',
        help='åˆ›å»ºç¬”è®°æœ¬',
        epilog="ç¤ºä¾‹: siyuan nb create \"æˆ‘çš„ç¬”è®°æœ¬\""
    )
    create_nb.add_argument('name', help='ç¬”è®°æœ¬åç§°')

    # nb remove
    remove_nb = nb_subparsers.add_parser('remove',
        help='åˆ é™¤ç¬”è®°æœ¬',
        epilog="ç¤ºä¾‹: siyuan nb remove \"æˆ‘çš„ç¬”è®°æœ¬\"  # æ”¯æŒä½¿ç”¨ç¬”è®°æœ¬åç§°æˆ– ID"
    )
    remove_nb.add_argument('notebook', help='ç¬”è®°æœ¬ ID æˆ–åç§°')
    remove_nb.add_argument('-y', '--yes', action='store_true', help='è·³è¿‡ç¡®è®¤ç›´æ¥åˆ é™¤')

    # nb rename
    rename_nb = nb_subparsers.add_parser('rename',
        help='é‡å‘½åç¬”è®°æœ¬',
        epilog="ç¤ºä¾‹: siyuan nb rename \"æ—§åç§°\" \"æ–°åç§°\""
    )
    rename_nb.add_argument('notebook', help='ç¬”è®°æœ¬ ID æˆ–åç§°')
    rename_nb.add_argument('name', help='æ–°åç§°')

    # nb open
    open_nb = nb_subparsers.add_parser('open',
        help='æ‰“å¼€ç¬”è®°æœ¬',
        epilog="ç¤ºä¾‹: siyuan nb open \"æˆ‘çš„ç¬”è®°æœ¬\""
    )
    open_nb.add_argument('notebook', help='ç¬”è®°æœ¬ ID æˆ–åç§°')

    # nb close
    close_nb = nb_subparsers.add_parser('close',
        help='å…³é—­ç¬”è®°æœ¬',
        epilog="ç¤ºä¾‹: siyuan nb close \"æˆ‘çš„ç¬”è®°æœ¬\""
    )
    close_nb.add_argument('notebook', help='ç¬”è®°æœ¬ ID æˆ–åç§°')

    # nb conf
    conf_nb = nb_subparsers.add_parser('conf',
        help='ç¬”è®°æœ¬é…ç½®',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  siyuan nb conf "æˆ‘çš„ç¬”è®°æœ¬" get           # è·å–é…ç½®
  siyuan nb conf "æˆ‘çš„ç¬”è®°æœ¬" set --key icon --value "ğŸ“š"  # è®¾ç½®é…ç½®
        """
    )
    conf_nb.add_argument('notebook', help='ç¬”è®°æœ¬ ID æˆ–åç§°')
    conf_nb.add_argument('operation', choices=['get', 'set'], help='æ“ä½œ')
    conf_nb.add_argument('--key', help='é…ç½®é”®')
    conf_nb.add_argument('--value', help='é…ç½®å€¼')

    # æ–‡æ¡£æ¨¡å—
    doc_parser = subparsers.add_parser(
        'doc',
        help='æ–‡æ¡£æ“ä½œ (document çš„ç®€å†™)',
        aliases=['document']
    )
    doc_subparsers = doc_parser.add_subparsers(dest='action', help='åŠ¨ä½œ')

    # doc show
    show_doc = doc_subparsers.add_parser('show',
        help='æŸ¥çœ‹æ–‡æ¡£å†…å®¹',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  siyuan doc show 20240101120000-abc123     # æŸ¥çœ‹æ–‡æ¡£å†…å®¹
  siyuan doc show 20240101120000-abc123 --format json  # JSON æ ¼å¼
        """
    )
    show_doc.add_argument('doc_id', help='æ–‡æ¡£ ID')
    show_doc.add_argument('--format', choices=['text', 'json'], default='text', help='è¾“å‡ºæ ¼å¼')

    # doc info
    info_doc = doc_subparsers.add_parser('info',
        help='æŸ¥çœ‹æ–‡æ¡£å…ƒä¿¡æ¯',
        epilog="ç¤ºä¾‹: siyuan doc info 20240101120000-abc123"
    )
    info_doc.add_argument('doc_id', help='æ–‡æ¡£ ID')

    # doc cat
    cat_doc = doc_subparsers.add_parser('cat',
        help='åœ¨ç»ˆç«¯æ˜¾ç¤ºæ–‡æ¡£å†…å®¹',
        epilog="ç¤ºä¾‹: siyuan doc cat 20240101120000-abc123  # ä»…è¾“å‡ºæ–‡æ¡£å†…å®¹"
    )
    cat_doc.add_argument('doc_id', help='æ–‡æ¡£ ID')

    # doc create
    create_doc = doc_subparsers.add_parser('create',
        help='åˆ›å»ºæ–‡æ¡£',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  siyuan doc create "æˆ‘çš„ç¬”è®°æœ¬" "/" --title "æ ‡é¢˜" --content "å†…å®¹"
  siyuan doc create "æˆ‘çš„ç¬”è®°æœ¬" "/çˆ¶æ–‡æ¡£" --title "å­æ ‡é¢˜"
  siyuan doc create "æˆ‘çš„ç¬”è®°æœ¬" "ä¸å­˜åœ¨çš„è·¯å¾„" --title "æ ‡é¢˜" --force  # å¼ºåˆ¶åˆ›å»º
        """
    )
    create_doc.add_argument('notebook', help='ç¬”è®°æœ¬åç§°')
    create_doc.add_argument('path', help='æ–‡æ¡£è·¯å¾„ï¼ˆçˆ¶æ–‡æ¡£è·¯å¾„ï¼Œå¦‚ "/" æˆ– "/çˆ¶æ–‡æ¡£"ï¼‰')
    create_doc.add_argument('--title', help='æ–‡æ¡£æ ‡é¢˜')
    create_doc.add_argument('--content', help='æ–‡æ¡£å†…å®¹')
    create_doc.add_argument('--force', action='store_true', help='å¼ºåˆ¶åˆ›å»ºï¼Œè·³è¿‡çˆ¶è·¯å¾„éªŒè¯')

    # doc rename
    rename_doc = doc_subparsers.add_parser('rename',
        help='é‡å‘½åæ–‡æ¡£',
        epilog="ç¤ºä¾‹: siyuan doc rename 20240101120000-abc123 \"æ–°æ ‡é¢˜\""
    )
    rename_doc.add_argument('doc_id', help='æ–‡æ¡£ ID')
    rename_doc.add_argument('new_title', help='æ–°æ ‡é¢˜')

    # doc move
    move_doc = doc_subparsers.add_parser('move',
        help='ç§»åŠ¨æ–‡æ¡£',
        epilog="ç¤ºä¾‹: siyuan doc move 20240101120000-abc123 --to 20240101120000-def456  # ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçˆ¶æ–‡æ¡£ä¸‹"
    )
    move_doc.add_argument('doc_id', help='æ–‡æ¡£ ID')
    move_doc.add_argument('--to', required=True, help='ç›®æ ‡ ID')

    # doc remove
    remove_doc = doc_subparsers.add_parser('remove',
        help='åˆ é™¤æ–‡æ¡£',
        epilog="ç¤ºä¾‹: siyuan doc remove 20240101120000-abc123"
    )
    remove_doc.add_argument('doc_id', help='æ–‡æ¡£ ID')
    remove_doc.add_argument('-y', '--yes', action='store_true', help='è·³è¿‡ç¡®è®¤ï¼Œç›´æ¥åˆ é™¤')

    # doc list
    list_doc = doc_subparsers.add_parser('list',
        help='åˆ—å‡ºæ–‡æ¡£',
        epilog="""
ç¤ºä¾‹:
  siyuan doc list "æˆ‘çš„ç¬”è®°æœ¬"           # åˆ—å‡ºè¯¥ç¬”è®°æœ¬çš„æ‰€æœ‰æ–‡æ¡£
  siyuan doc list "æˆ‘çš„ç¬”è®°æœ¬" --tree   # ä»¥æ ‘çŠ¶ç»“æ„æ˜¾ç¤º
  siyuan doc list "æˆ‘çš„ç¬”è®°æœ¬" --filter "æµ‹è¯•"  # è¿‡æ»¤åŒ…å«"æµ‹è¯•"çš„æ–‡æ¡£
        """
    )
    list_doc.add_argument('notebook', help='ç¬”è®°æœ¬åç§°')
    list_doc.add_argument('--tree', action='store_true', help='ä»¥æ ‘çŠ¶ç»“æ„æ˜¾ç¤º')
    list_doc.add_argument('--filter', help='è¿‡æ»¤å…³é”®è¯')

    # å—æ¨¡å—
    blk_parser = subparsers.add_parser(
        'blk',
        help='å—æ“ä½œ (block çš„ç®€å†™)',
        aliases=['block']
    )
    blk_subparsers = blk_parser.add_subparsers(dest='action', help='åŠ¨ä½œ')

    # blk show
    show_blk = blk_subparsers.add_parser('show',
        help='æŸ¥çœ‹å—ä¿¡æ¯',
        epilog="""
ç¤ºä¾‹:
  siyuan blk show 20240101120000-abc123
  siyuan blk show 20240101120000-abc123 --format json
        """
    )
    show_blk.add_argument('block_id', help='å— ID')
    show_blk.add_argument('--format', choices=['text', 'json'], default='text', help='è¾“å‡ºæ ¼å¼')

    # blk info
    info_blk = blk_subparsers.add_parser('info',
        help='æŸ¥çœ‹å—å…ƒä¿¡æ¯',
        epilog="ç¤ºä¾‹: siyuan blk info 20240101120000-abc123"
    )
    info_blk.add_argument('block_id', help='å— ID')

    # blk update
    update_blk = blk_subparsers.add_parser('update',
        help='æ›´æ–°å—å†…å®¹',
        epilog="ç¤ºä¾‹: siyuan blk update 20240101120000-abc123 --content \"æ–°å†…å®¹\""
    )
    update_blk.add_argument('block_id', help='å— ID')
    update_blk.add_argument('--content', required=True, help='æ–°å†…å®¹')

    # blk append
    append_blk = blk_subparsers.add_parser('append',
        help='è¿½åŠ å­å—',
        epilog="ç¤ºä¾‹: siyuan blk append 20240101120000-abc123 --content \"å­å—å†…å®¹\""
    )
    append_blk.add_argument('parent_id', help='çˆ¶å— ID')
    append_blk.add_argument('--content', required=True, help='å†…å®¹')

    # blk prepend
    prepend_blk = blk_subparsers.add_parser('prepend',
        help='å‰ç½®å­å—',
        epilog="ç¤ºä¾‹: siyuan blk prepend 20240101120000-abc123 --content \"å‰ç½®å—å†…å®¹\""
    )
    prepend_blk.add_argument('parent_id', help='çˆ¶å— ID')
    prepend_blk.add_argument('--content', required=True, help='å†…å®¹')

    # blk move
    move_blk = blk_subparsers.add_parser('move',
        help='ç§»åŠ¨å—',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  siyuan blk move 20240101120000-abc123 --to 20240101120000-def456
  siyuan blk move 20240101120000-abc123 --to 20240101120000-def456 --after 20240101120000-xyz789
        """
    )
    move_blk.add_argument('block_id', help='å— ID')
    move_blk.add_argument('--to', required=True, help='ç›®æ ‡çˆ¶å— ID')
    move_blk.add_argument('--after', help='å‰ä¸€ä¸ªå— ID')

    # blk delete
    delete_blk = blk_subparsers.add_parser('delete',
        help='åˆ é™¤å—',
        epilog="ç¤ºä¾‹: siyuan blk delete 20240101120000-abc123"
    )
    delete_blk.add_argument('block_id', help='å— ID')
    delete_blk.add_argument('-y', '--yes', action='store_true', help='è·³è¿‡ç¡®è®¤ï¼Œç›´æ¥åˆ é™¤')

    # blk attr
    attr_blk = blk_subparsers.add_parser('attr',
        help='å—å±æ€§æ“ä½œ',
        epilog="""
ç¤ºä¾‹:
  siyuan blk attr 20240101120000-abc123 get --key id
  siyuan blk attr 20240101120000-abc123 set --key custom --value "è‡ªå®šä¹‰å€¼"
  siyuan blk attr 20240101120000-abc123 unset --key custom
        """
    )
    attr_blk.add_argument('block_id', help='å— ID')
    attr_blk.add_argument('action', choices=['get', 'set', 'unset'], help='æ“ä½œ')
    attr_blk.add_argument('--key', help='å±æ€§é”®')
    attr_blk.add_argument('--value', help='å±æ€§å€¼')

    # æŸ¥è¯¢æ¨¡å—
    query_parser = subparsers.add_parser('query', help='æŸ¥è¯¢å’Œæœç´¢')
    query_subparsers = query_parser.add_subparsers(dest='action', help='åŠ¨ä½œ')

    sql_query = query_subparsers.add_parser('sql',
        help='æ‰§è¡Œ SQL æŸ¥è¯¢',
        epilog="""
ç¤ºä¾‹:
  siyuan query sql "SELECT * FROM blocks WHERE type='d' LIMIT 10"
  siyuan query sql "SELECT * FROM blocks WHERE content LIKE '%æµ‹è¯•%'" --format json
        """
    )
    sql_query.add_argument('stmt', help='SQL è¯­å¥')
    sql_query.add_argument('--format', choices=['text', 'json'], default='text', help='è¾“å‡ºæ ¼å¼')

    # query search
    search_query = query_subparsers.add_parser('search',
        help='æœç´¢å†…å®¹',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  siyuan query search "å…³é”®è¯"                     # å…¨å±€æœç´¢
  siyuan query search "å…³é”®è¯" --notebook "æˆ‘çš„ç¬”è®°æœ¬"  # æŒ‡å®šç¬”è®°æœ¬
  siyuan query search "RDMA" --type d  # åªæœç´¢æ–‡æ¡£
  siyuan query search "æµ‹è¯•" --limit 5  # é™åˆ¶è¿”å›æ•°é‡
        """
    )
    search_query.add_argument('keyword', help='æœç´¢å…³é”®è¯')
    search_query.add_argument('--notebook', help='ç¬”è®°æœ¬åç§°')
    search_query.add_argument('--type', help='å—ç±»å‹')
    search_query.add_argument('--limit', type=int, default=10, help='è¿”å›æ•°é‡é™åˆ¶')
    # query attr
    attr_query = query_subparsers.add_parser('attr',
        help='æŒ‰å±æ€§æŸ¥è¯¢',
        epilog="""
ç¤ºä¾‹:
  siyuan query attr "custom-prop" "value"                    # å…¨å±€æŸ¥æ‰¾
  siyuan query attr "status" "todo" --notebook "æˆ‘çš„ç¬”è®°æœ¬"   # æŒ‡å®šç¬”è®°æœ¬
        """
    )
    attr_query.add_argument('key', help='å±æ€§é”®')
    attr_query.add_argument('value', help='å±æ€§å€¼')
    attr_query.add_argument('--notebook', help='ç¬”è®°æœ¬åç§°')

    # query recent
    recent_query = query_subparsers.add_parser('recent',
        help='æœ€è¿‘æ›´æ–°',
        epilog="""
ç¤ºä¾‹:
  siyuan query recent          # æœ€è¿‘æ›´æ–°çš„ 20 ä¸ªå—
  siyuan query recent --limit 50  # æœ€è¿‘æ›´æ–°çš„ 50 ä¸ªå—
        """
    )
    recent_query.add_argument('--limit', type=int, default=20, help='è¿”å›æ•°é‡é™åˆ¶')

    # èµ„æºæ–‡ä»¶æ¨¡å—
    asset_parser = subparsers.add_parser('asset', help='èµ„æºæ–‡ä»¶æ“ä½œ')
    asset_subparsers = asset_parser.add_subparsers(dest='action', help='åŠ¨ä½œ')

    # asset upload
    upload_asset = asset_subparsers.add_parser('upload',
        help='ä¸Šä¼ æ–‡ä»¶',
        epilog="""
ç¤ºä¾‹:
  siyuan asset upload /path/to/image.png                       # ä¸Šä¼ åˆ°é»˜è®¤è·¯å¾„
  siyuan asset upload /path/to/file.pdf --to "/assets/docs/"      # æŒ‡å®šç›®æ ‡è·¯å¾„
        """
    )
    upload_asset.add_argument('file', help='æ–‡ä»¶è·¯å¾„')
    upload_asset.add_argument('--to', default='/assets/', help='ç›®æ ‡è·¯å¾„')

    # asset download
    download_asset = asset_subparsers.add_parser('download',
        help='ä¸‹è½½æ–‡ä»¶',
        epilog="""
ç¤ºä¾‹:
  siyuan asset download image.png                        # ä¸‹è½½åˆ°å½“å‰ç›®å½•çš„ assets/
  siyuan asset download /assets/photo.jpg               # ä¸‹è½½ assets ä¸­çš„æ–‡ä»¶
  siyuan asset download image.png -o ~/Downloads/       # æŒ‡å®šè¾“å‡ºç›®å½•
  siyuan asset download /data/notebook/doc.sy -o .      # ä¸‹è½½ä»»æ„æ–‡ä»¶
        """
    )
    download_asset.add_argument('path', help='æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒç›¸å¯¹è·¯å¾„ã€assetsè·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼‰')
    download_asset.add_argument('-o', '--output', help='è¾“å‡ºè·¯å¾„ï¼ˆé»˜è®¤: ./assets/æ–‡ä»¶åï¼‰', default=None)

    # å¯¼å‡ºæ¨¡å—
    export_parser = subparsers.add_parser('export', help='å¯¼å‡ºåŠŸèƒ½')
    export_subparsers = export_parser.add_subparsers(dest='action', help='åŠ¨ä½œ')

    # export md
    md_export = export_subparsers.add_parser('md',
        help='å¯¼å‡ºä¸º Markdown',
        epilog="""
ç¤ºä¾‹:
  siyuan export md 20240101120000-abc123
  siyuan export md 20240101120000-abc123 --output ./document.md
        """
    )
    md_export.add_argument('doc_id', help='æ–‡æ¡£ ID')
    md_export.add_argument('--output', help='è¾“å‡ºæ–‡ä»¶è·¯å¾„')

    # export zip
    zip_export = export_subparsers.add_parser('zip',
        help='å¯¼å‡ºä¸º ZIP',
        epilog="ç¤ºä¾‹: siyuan export zip \"/æ–‡æ¡£è·¯å¾„1\" \"/æ–‡æ¡£è·¯å¾„2\" --name \"backup.zip\""
    )
    zip_export.add_argument('paths', nargs='+', help='è·¯å¾„åˆ—è¡¨')
    zip_export.add_argument('--name', help='ZIP æ–‡ä»¶å')


    return parser


def main():
    """ä¸»å‡½æ•°"""
    parser = create_parser()
    args = parser.parse_args()

    # å¦‚æœæ²¡æœ‰æä¾›æ¨¡å—ï¼Œæ˜¾ç¤ºå¸®åŠ©
    if not args.module:
        parser.print_help()
        return 0

    try:
        # åˆ›å»ºè·¯ç”±å™¨
        router = CommandRouter()

        # å‡†å¤‡å‚æ•°
        kwargs = vars(args)
        module_name = kwargs.pop('module')
        # list å‘½ä»¤ä¸éœ€è¦ action
        if module_name == 'list':
            action = None
        else:
            action = kwargs.pop('action')

        # å¦‚æœæ²¡æœ‰æä¾› actionï¼ˆé™¤äº† list å‘½ä»¤ï¼‰ï¼Œæ˜¾ç¤ºå¸®åŠ©
        if action is None and module_name != 'list':
            print(f"âœ— é”™è¯¯: ç¼ºå°‘å­å‘½ä»¤\n")
            print(f"ğŸ’¡ æç¤º: ä½¿ç”¨ 'python3 siyuan {module_name} --help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤\n")

            # å°è¯•è°ƒç”¨å­å‘½ä»¤çš„å¸®åŠ©
            try:
                # ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ˜¾ç¤ºå¸®åŠ©ï¼Œè¿™æ ·å¯ä»¥çœ‹åˆ°å®Œæ•´çš„å­å‘½ä»¤åˆ—è¡¨
                import subprocess
                result = subprocess.run(
                    ['python3', 'siyuan', module_name, '--help'],
                    capture_output=True,
                    text=True
                )
                if result.returncode == 0:
                    print(result.stdout)
            except:
                pass

            return 1

        # è·¯ç”±å‘½ä»¤
        router.route(module_name, action or '__call__', **kwargs)
        return 0

    except SiyuanError as e:
        # å½“æ²¡æœ‰æä¾› action æ—¶ï¼Œæ˜¾ç¤ºæ¨¡å—å¸®åŠ©
        if "ä¸æ”¯æŒå‘½ä»¤" in str(e) and action is None:
            parser = create_parser()
            # æ‰¾åˆ°å¯¹åº”çš„å­è§£æå™¨
            for action_name, subparsers in [
                ('nb', [parser._subparsers._actions[0]] if parser._subparsers._actions else []),
                ('notebook', [parser._subparsers._actions[0]] if parser._subparsers._actions else []),
            ]:
                try:
                    subparser = next(sp for sp in parser._subparsers._actions if hasattr(sp, 'dest') and sp.dest == module_name)
                    if subparser:
                        subparser.print_help()
                        return 0
                except:
                    pass
            # å¦‚æœæ‰¾ä¸åˆ°ç‰¹å®šå¸®åŠ©ï¼Œæ˜¾ç¤ºé€šç”¨å¸®åŠ©
            print(f"âœ— é”™è¯¯: {e}")
        else:
            print(f"âœ— é”™è¯¯: {e}")
            return 1
    except KeyboardInterrupt:
        print("\næ“ä½œå·²å–æ¶ˆ")
        return 130
    except Exception as e:
        print(f"âœ— æœªé¢„æœŸçš„é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    sys.exit(main())
